<div class="bg-map"></div>

<%= render :partial => 'orders/header' %>

<%= form_for @order do |f| %>
  <ul class="templates">
    <% @templates_list.each do |template| -%>
      <li><%= link_to t(".templates-list.#{template.name}"), '#', :class => template.name %></li>
    <% end -%>
  </ul>

  <div class="map">
    <div class="browser">
      <div id="map"></div>
    </div>
    <div class="shadow bottom"></div>
  </div>

  <div id="container"></div>

  <section class="hidden">
  <div class="inner">
    <ul id="templates-detail">
      <li class="template selected">
      <p><%= t('.templates-detail.select_one_type') %></p>
      </li>

      <% @templates_list.each do |template| -%>
        <li class="template <%= template.name %>">
        <%= f.hidden_field :template_type, :value => template.id, :disabled => true %>
        <h4><%= t(".templates-detail.#{template.name}.title") %></h4>
        <p><%= t(".templates-detail.#{template.name}.description") %></p>

        <% if template.price.present? -%>
          <span class="price"><%= t(".templates-detail.#{template.name}.price", :price => template.price) %></span>
        <% end -%>

        <% if template.visualization_methods.present? -%>
          <h4><%= t('.templates-detail.visualization_method') %></h4>
          <ul class="visualization_method">
            <% template.visualization_methods.each do |visualization_method| -%>
              <li>
              <%= f.radio_button :visualization_method, :value => visualization_method.id %>
              <%= f.label :visualization_method, t(".templates-detail.visualization_methods.#{visualization_method.name}.name") %>
              <p>
              <%= t(".templates-detail.visualization_methods.#{visualization_method.name}.description") %>
              </p>
              </li>
            <% end -%>
          </ul>
        <% end -%>

        <ul class="options">
          <% template.options.each do |option| -%>
            <li>
            <%= f.fields_for :order_options, @order.order_options.build do |ff| %>

              <%= checkbox ff, :template_option_id, option.name, option.id %>


              <span class="label_price">(<%= t(".templates-detail.template_options.#{option.name}.price", :price => option.price) %>)</span>

              <p><%= t(".templates-detail.template_options.#{option.name}.description") %></p>
              <div class="ellipsis">...</div>
              <div class="option_price"><%= t(".templates-detail.template_options.#{option.name}.price", :price => option.price) %></div>
            <% end -%>
            </li>
          <% end -%>
        </ul>

        <% if template.price.present? -%>
          <div class="total">
            <%= f.hidden_field :total, :disabled => true %>
            <h3><%= t('.total.title') %></h3>
            <div class="ammount"><%= t('.total.ammount_html', :price => template.price) %></div>
          </div>
        <% end -%>
        </li>
      <% end -%>
    </ul>
  </div>
  </section>

  <section class="highlighted">
  <div class="inner">
    <div class="left">
      <h3 class="bottom-5"><%= t('.your_data.title') %></h3>
      <p class="bottom-20"><%= t('.your_data.description') %></p>

      <div class="input-field upload">
        <input type="text" />
        <div class="placeholder">
          <div class="icon"></div>
          <span><%= t('.your_data.drag_drop') %></span>
          <%= link_to t('.your_data.select_files'), '#' %>
        </div>
      </div>
    </div>
  </div>
  </section>

  <section class="comments">
  <div class="left">

    <div class="inner">
      <div class="field left">
        <label for="name"><%= t('.contact_info.name') %></label>
        <div class="input-field">
          <input type="text" value="" name="name" />
        </div>
      </div>


      <div class="field right">
        <label for="email"><%= t('.contact_info.email') %></label>
        <div class="input-field">
          <input type="text" value="" name="email" />
        </div>
      </div>

      <div class="field">
        <label for="comments"><%= t('.contact_info.comments') %></label>
        <div class="textarea">
          <textarea value="" name="comments"></textarea>
        </div>
      </div>
    </div>
  </div>

  </section>

  <section class="submit centered">
  <div class="inner">
    <%= f.submit t('.submit'), :class => "button blue" %>
  </div>
  </section>

<% end %>

<%= render :partial => 'home/footer' %>


<% content_for :js do %>
  <script type="text/template" id="field-template">
    {{ if (type) { }}

      {{ if (type === 'title') { }}
        <h3 class="{{= type }}"> {{= title }} </h3>
        {{ } else { }}

        <a class="{{= type }} {{ if (checked) {}} checked {{ } }}" name="{{= name }}">
          {{= title }} {{ if (price > 0) { }} ${{= price }} {{ } }}
        </a>
        {{ } }}

      {{ } else { }}

      {{= title }} {{ if (price > 0) { }} ${{= price }} {{ } }}

      {{ } }}

    {{ if (description) { }}
      <p>{{= description }}</p>
      {{ } }}

    {{ if ( price > 0 ) { }}<div class="price">${{= price }}</div>{{ } }}

  </script>

  <script type="text/template" id="fixed-template">
    <section class="dark">
    <div class="left border">
      <div class="inner">
        <ul class="prices">
          <li>
          <h3>{{= title }}</h3>
          {{ if (description) { }}
            <p>{{= description }}</p>
            {{ } }}
          <span class="price">${{= price }}</span>
          </li>
        </ul>
      </div>
    </div>
    </section>
  </script>

  <script type="text/template" id="form-template">

    <div class="fixed"></div>
    <div class="circle"></div>

    <section>
    <div class="left border">
      <div class="inner">
        <ul class="prices test"></ul>
      </div>
    </div>
    </section>

    <section>
    <div class="left border">
      <div class="inner">
        <h3 class="total">Total</h3>
      </div>
    </div>
    <div class="right">
      <div class="inner">
        <span class="subtotal price">Starting from {{= total }} </span>
      </div>
    </div>
    </section>
  </script>



  <script type="text/javascript">
    $(function() {

        var map = new cdb.geo.Map({
        center: [18.289374355860424, 59.765625]
          
        });

        map.setCenter([18.289374355860424, 59.765625]);

        var mapView = new cdb.geo.LeafletMapView({
          el: $('#map'),
          map: map
        });

        map.setZoom(2);

        map.bind('change:center', function(model, center) {
          console.log(center[0], center[1]);
        });

        var URL = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png';
        var layer = new cdb.geo.TileLayer({ urlTemplate: URL });
        map.addLayer(layer);

        var fields = new cdb.ui.common.Fields([
          { callback: null, className: null,        checked: false, title: "Visualization method",  name: false, type: "title",    price: 0,    description: false },
          { callback: null, className: null,        checked: false, title: "Density map",           name: "z",   type: false,      price: 2000, description: "Includes data process & visualization." },
          { callback: null, className: null,        checked: true,  title: "Rectangular grid",      name: "a",   type: 'radio',    price: 0,    description: "Group and represent data using an hexagonal grid" },
          { callback: null, className: null,        checked: false, title: "Hexagonal grid",        name: "a",   type: 'radio',    price: 0,    description: "Group and represent data using a rectangular grid" },
          { callback: null, className: null,        checked: false, title: "Circular grid",         name: "a",   type: 'radio',    price: 0,    description: "this is a description" },
          { callback: null, className: "separator", checked: false, title: "Variable selection",    name: "b",   type: 'checkbox', price: 100,  description: "This allows your users to toggle between different variables to visualize." },
          { callback: function() {

            var style = "#github_javascript{[prop_count>0]{polygon-fill:#313695;}[prop_count>1]{polygon-fill:#4575B4;}[prop_count>2]{polygon-fill:#74ADD1;}[prop_count>4]{polygon-fill:#ABD9E9;}[prop_count>8]{polygon-fill:#E0F3F8;}[prop_count>16]{polygon-fill:#FFFFBF;}[prop_count>32]{polygon-fill:#FEE090;}[prop_count>64]{polygon-fill:#FDAE61;}[prop_count>128]{polygon-fill:#F46D43;}[prop_count>256]{polygon-fill:#D73027;}[prop_count>512]{polygon-fill:#A50026;}polygon-opacity:0.71;line-width:0;}";
            var query = "WITH hgrid AS (SELECT CDB_HexagonGrid(ST_Expand(CDB_XYZ_Extent({x},{y},{z}),CDB_XYZ_Resolution({z}) * 15),CDB_XYZ_Resolution({z}) * 15) as cell) SELECT hgrid.cell as the_geom_webmercator, count(i.cartodb_id) as prop_count FROM hgrid, github_javascript i WHERE ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell";

            // style = "#github_javascript{ marker-fill:#333333; marker-width:5; marker-opacity:.75; marker-line-width:0; marker-placement:point; marker-type:ellipse; marker-allow-overlap:true; }"
            // query ="SELECT * FROM {{table_name}}";

            return map.addLayer(new cdb.geo.CartoDBLayer({
              options: {
                user_name:'saleiva',
                table_name: 'github_javascript',
                style: style,
                query: query,
                interactivity: "cartodb_id"
              }

            // return map.addLayer(new cdb.geo.CartoDBLayer({
            //   options: {
            //     user_name: 'examples',
            //     table_name: 'earthquakes',
            //     query: 'SELECT * FROM {{table_name}}',
            //     tile_style: "#{{table_name}}{marker-fill:red}",
            //     interactivity: "cartodb_id, magnitude",
            //   }
            }));

          }, className: null,        checked: false, title: "Color selection",       name: "c",   type: 'checkbox', price: 200,  description: "This allows your users to toggle between different variables to visualize." }
        ]);

        window.formModel = new cdb.ui.common.FormModel({ base: 0, total: 0 });
        window.app       = new cdb.ui.common.Form({ map: map, model: window.formModel, collection: fields });

        $("#container").append(window.app.render());


      });
  </script>

<% end %>
